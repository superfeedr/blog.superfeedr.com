<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="ofroHQ3qXBS1SQfblK9-U_oduGZ975Bb3i_uP13Myao" />

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,400italic|Source+Code+Pro:400,600' rel='stylesheet' type='text/css'>

  <link href="/css/front.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/css/prism.css" rel="stylesheet" type="text/css">

  <title>Superfeedr : Post Mortem 02/11 </title>

  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
  <link rel="webmention" href="https://webmention.herokuapp.com/api/webmention" />

  <meta http-equiv="Content-Security-Policy" content="connect-src stream.superfeedr.com">

  <link rel="shortcut icon" href="/favicon.png">

</head>
<body>
  <header class="header">
    <div class="container">
      <h1 class="header-logo"><a href="/"><img src="/images/logo.png" alt=""> <span>Superfeedr Blog</span></a></h1>
      <nav class="nav-header">
        <ul class="nav-items">
          <li class="nav-item"><a href="http://superfeedr.com/about" class="nav-link">About</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/publisher" class="nav-link">Publishers</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/subscriber" class="nav-link">Subscribers</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/subscriber/pricing" class="nav-link">Pricing</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/login" class="nav-link nav-link-bubble">Login</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container body">
    <header class="body-header">
      <div class="blog-links">
        <input type="button" class="button  button--raised  button--positive" value="Subscribe" onclick="(function(){var z=document.createElement('script');z.src='http://www.subtome.com/load.js';document.body.appendChild(z);})()">
        <a href="/archive.html" class="button  button--raised  button--neutral">Read Archives</a>
      </div>
      <h2><strong>Blog</strong></h2>
    </header>

    <div class="body-content">
      <section class="column  column--terms  body-content-text">
        <article class="blog-article blog-article--single h-entry">
  <h3 class="entry-title p-name"><a class="u-url" href="/post-mortem/mysql/memcache/post-mortem-02-11">Post Mortem 02/11</a></h3>

  <span class="invisible u-uid" style="display:none">blog.superfeedr.com:/post-mortem/mysql/memcache/post-mortem-02-11</span>

  <div class="entry-meta">
    <ul class="entry-meta--primary postmeta">
      <li class="entry-meta--item">By <span class="p-author h-card"><img class="u-photo" src="http://www.gravatar.com/avatar/b30ce50678f0e934eaa6697425c59dd7?s=20" > <a href="http://ouvre-boite.com" rel="author">Julien</a></span></li>
      <li class="entry-meta--item dt-published" datetime="2009-11-03T00:00:00+01:00"><time>03 Nov 2009</time></li>
    </ul>
  </div>
  <div class="entry-content e-content">
    <p>Superfeedr went down yesterday evening. We immediately saw that it was a <strong>database performance issue</strong> (MySQL), given that the load on our <em>MySQL host was about 30+</em>. Since we have 2 MySQL hosts (Master &#8211; Master replication), we switched to the second one, hoping that was just a problem on the host. No luck.</p>
<h3>Finding the issue</h3>
<p>Up until yesterday, our entry detection was was done by <strong>storing in Memcached and MySQL an unique identifier by entry</strong>. If the item was not present in Memcached, it would be inserted into MySQL, which has a unique index on these unique ids. The goal of that is that a check on Memcached is much cheaper than a check on MySQL. We had then a maintenance script that would clean up the entries that are old enough to not be considered new again.</p>
<p>When we investigated a little further yesterday, we found that the it was actually <strong>these <span class="caps">INSERT</span> queries on MySQL that were taking much longer than they should, and, worse, much more often than they should</strong>.</p>
<p>Logically, we checked our Memcached and found out that our caching mechanism didn&#8217;t work as expected: <em>whether the unique entry was present in the cache or not, we would send the entry to be saved in MySQL</em>. We fixed that. But the problem was still the same : way too many INSERTs in MySQL.</p>
<p>After checking Memcached into more details, we figured out that our keys were &#8220;disappearing&#8221;. Looking at <a href="http://code.google.com/p/memcached/wiki/FAQ#My_cache_items_always_expire_early!_My_cache_never_fills_all_the">Memcached&#8217;s <span class="caps">FAQ</span></a> was helpful. <em>We indeed had a flush somewhere, that we had forgotten about</em>. Removing the flush was good. The load on MySQL started to decrease, but not enough.</p>
<p>There was a problem with MySQL. Another proof of that is that the 2 issues we had in our cache system had been here for weeks.</p>
<p>After checking the entries table, it had about <strong>65 Million rows, 12GB Data and a 15GB Index</strong>. Every time we insert a row, it has to check the keys. And since we&#8217;re inserting about <strong>100 new rows per seconds</strong>, even small operations start to become too heavy, specially if they involve disk access (we don&#8217;t have 15GB <span class="caps">RAM</span> on the MySQL host).</p>
<p>We had to clean this table. It was easy to see that some feeds had more than 1M entries in MySQL. We started some queries to clean them up. It took 7hours and didn&#8217;t complete. We needed to be back up faster than that.</p>
<h3>Fixing the problem</h3>
<p>Here is what we did : we changed the way we store entries in MySQL. Instead of cleaning them only once they&#8217;re too old, <strong>we only keep in the cache a handful of entries : twice the size of the feed</strong> actually, so that we don&#8217;t store millions of useless entries, and we clean these entries each time we add some.</p>
<p>The &#8220;reboot&#8221; process comes next :</p>
<ol>
	<li>We then truncated the entries table,</li>
	<li>We stopped the notifications,</li>
	<li>We restarted Memcached to clean any cached entries,</li>
	<li>We forced all the feeds to be ran through our parser once to populate the entries table again.</li>
	<li>When that was done, we restarted the notifications, and Superfeedr was back up.</li>
</ol>
<p>There is a small risk for you to see duplicate entries (if the feed couldn&#8217;t be parsed/fetched during the populating phase), but that should stay minimal.</p>
<h3>What did we lean?</h3>
<ul>
	<li><strong>MySQL is not the right tool for what we do</strong>. Unfortunately, we haven&#8217;t found any tool that really complies by all of our requirements. We studied several of the NoSQL alternative. We&#8217;ll do that again in the coming days.</li>
</ul>
<ul>
	<li><strong>A problem can have several causes</strong>. The first one you find might not be the good one.</li>
</ul>
<ul>
	<li><strong>You have to take drastic steps earlier</strong> : trying the &#8220;soft&#8221; methods may sometimes just be a time loss. We should have not even tried to clean only parts of the entries table and that lost us about 7 hours.</li>
</ul>
<p>We know we may pay a price for these lessons in terms of customer and conversion rate. We also know how valuable these lessons are and this also validates our biggest assumption that nobody else should build a similar infrastructure. Of course, not everybody would have fallen into those traps, but at least, if you use us, <a href="http://blog.superfeedr.com/gospel/something-stupid/">we did that for you, too</a>.</p>
<p>Please, let us know what we can improve and how to be better. We also learn from you.</p>
  </div>
</article>
<div class="blog-more">
  Liked this post? <a href="/archive.html">Read the archive</a> or <input type="button" value="Subscribe" class="button  button--raised  button--positive" onclick="(function(){var z=document.createElement('script');z.src='http://www.subtome.com/load.js';document.body.appendChild(z);})()">
</div>
<div class="blog-comments">
  <h3>Comments</h3>

    <div id="disqus_thread">
    </div>

    <script type="text/javascript" src="https://disqus.com/forums/superfeedr-thoughts/embed.js"></script>
    <noscript>
        <a href="https://superfeedr-thoughts.disqus.com/?url=ref">View the discussion thread.</a>
    </noscript>

    <script id="webmention-hosted">
    (function () {
      var sn = document.createElement("script"), s = document.getElementsByTagName("script")[0], url;
      url = document.querySelectorAll ? document.querySelectorAll("link[rel~=canonical]") : false;
      url = url && url[0] ? url[0].href : false;
      sn.type = "text/javascript"; sn.async = true;
      sn.src = "//webmention.herokuapp.com/api/embed?url=" + encodeURIComponent(url || window.location);
      s.parentNode.insertBefore(sn, s);
    }());
    </script>
</div>

      </section>
    </div>

  </main>

  <div class="footer container">
    <footer class="site-footer">
      <ul class="site-footer__list">
<!--         <li class="site-footer__item"><a href="" class="site-footer__link">Documentation</a></li>
        <li class="site-footer__item"><a href="" class="site-footer__link">Support</a></li>
        <li class="site-footer__item"><a href="" class="site-footer__link">Blog</a></li>
        <li class="site-footer__item"><a href="/pricing.html" class="site-footer__link">Pricing</a></li>
        <li class="site-footer__item"><a href="" class="site-footer__link">Terms</a></li>
 -->      </ul>
      <ul class="site-footer__meta">
        <p class="site-footer__copyright">&copy; 2009&ndash;2014 Superfeedr</p>
      </ul>
    </footer>
  </div>



  


  <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script>
  <script type="text/javascript">
  <!--//--><![CDATA[//><!--
  try {
    var pageTracker = _gat._getTracker('UA-9285763-1');
    pageTracker._setDomainName("superfeedr.com");
    pageTracker._initData();
    pageTracker._trackPageview();
  } catch(err) {}
  //--><!]]>
  </script>

  <script src="/scripts/prism.js"></script>

</body>
</html>



